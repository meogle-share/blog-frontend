name: deploy
on:
  workflow_run:
    workflows: ["ci"]
    types:
      - completed
  workflow_dispatch:

env:
  IMAGE_NAME: meogle-ui
  BOT_NAME: "meogle-deploy[bot]"
  BOT_EMAIL: "meogle-deploy[bot]@meogle.com"

jobs:
  update-helm:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, production]
    steps:
      - name: Checkout infra repository
        uses: actions/checkout@v3
        with:
          repository: meogle-share/blog-infra
          token: ${{ secrets.GIT_HUB_HASH_PAT }}
          ref: main

      - name: Update image in values.yaml
        uses: mikefarah/yq@v4
        with:
          cmd: |
            yq eval -i '                                                                                                          
              .image.repository = "willom2c/${{ env.IMAGE_NAME }}" |                                                              
              .image.tag = "${{ github.event.workflow_run.head_sha }}"                                                            
            ' ./apps/${{ env.IMAGE_NAME }}/values.yaml                                                             

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ðŸ¤– ci(deploy): update ${{ env.IMAGE_NAME }} image tag                                                                 
            
            - Application: ${{ env.IMAGE_NAME }}                                                                                  
            - New Tag: ${{ github.event.workflow_run.head_sha }}                                                                  
            - Workflow: ${{ github.workflow }}                                                                                    
            - Triggered by: ${{ github.actor }}                                                                                   
            - Build URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}                      
            
            Auto-generated by GitHub Actions
          branch: main
          file_pattern: "apps/${{ env.IMAGE_NAME }}/values.yaml"
          commit_user_name: ${{ env.BOT_NAME }}
          commit_user_email: ${{ env.BOT_EMAIL }}
          repository: .